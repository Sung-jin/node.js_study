# 프록시

* 연관된 객체를 처음부터 데이터베이스에서 조회하는 것이 아닌, 실제 사용하는 시점에 데이터를 사용할 수 있는 방법.
* 실제 객체 엔티티가 아닌, 데이터베이스 조회를 지연할 수 있는 가짜 객체를 프록시라고 한다.
* 객체 조회시
    * em.find(Entity.class, 1) - 실제 사용여부와 상관없이 데이터베이스에서 조회한다.
    * em.getReference(Entity.class, 1) - 실제로 해당 객체(프록시)를 사용할 시 데이터베이스에서 조회한다.
        * 해당 함수는 데이터베이스에 접근을 위임한 프록시 객체를 반환한다.

## 프록시 객체의 특징

![](../images/7.Proxy%20construction.png)

* 프록시 클래스는 상속 받아서 만들어 지므로, 실제 클래스와 겉 모양이 같다.
* 프록시 객체는 실제 객체에 대한 참조(target)를 보관한다.
    * 프록시 객체의 메소드를 호출하면 프록시 객체는 실제 객체의 메소드를 호출한다.

## 프록시 객체의 초기화

* 프록시 객체가 실제 사용될 때 데이터베이스를 조회해서 실제 엔티티를 생성하는데, 이것을 프록시 객체의 초기화라고 한다.
* 프록시 객체의 초기화 과정
    1. 프록시 객체에서 특정 필드를 조회하는 메소드를 호출할 때, 실제 데이터를 조회한다.
    2. 프록시 객체는 실제 엔티티가 생성되어 있지 않으면 영속성 컨텍스트에 실제 엔티티 생성을 요청하는데 이를 초기화라 한다.
    3. 영속성 컨텍스트는 데이터베이스를 조회해서 실제 엔티티 객체를 생성한다.
    4. 프록시 객체는 생성된 실제 엔티티 객체를 참조를 target 멤버변수에 보관한다.
    5. 프록시 객체는 실제 엔티티 객체의 사용한 메소드를 호출하여, 해당 결과를 반환한다.

## 프록시 특징

* 프록시 객체는 처음 사용할 때 한번만 초기화 된다.
* 프록시 객체를 초기화한다고 프록시 객체가 실제 엔티티로 바뀌는 것이 아니다.
    * 프록시 객체가 초기화되면 프록시 객체를 통해서 실제 엔티티에 접근할 수 있을 뿐이다.
* 프록시 객체는 원본 엔티티를 상속받은 객체이므로, 타입 체크시에 주의해서 사용해야 한다.
* em.getReference() 를 이용하여 프록시 객체를 호출하였어도, 해당 객체가 영속성 컨텍스트 안에 존재한다면 영속성 컨텍스트 안에 있는 실제 엔티티를 반환한다.
* 초기화는 영속성 컨텍스트의 도움을 받아야 가능하다.
    * 그래서 준영속 상태의 프록시를 초기화하면 org.hibernate.LazyInitializationException 예외가 발생한다.

```java
// 준영속 상태의 초기화
Entity entity = em.getReference(Entity.class, 1);
...
em.clsoe(); // 영속성 컨텍스트 종료

entity.getField(); // 준영속 상태 초기화 시도
// org.hibernate.LazyInitializationException 발생
```

## 프록시와 식별자

* 엔티티를 프록시로 조회할 때 PK 값을 파라미터로 전달하는데, 프록시 객체는 이 식별자 값을 보관한다.
* 그래서 아래와 같이 프록시 객체에서 id 를 조회해도 해당 프록시가 초기화 되지 않는다.
* 연관관계를 설정할 떄는 식별자 값만 사용하므로, 프록시를 사용하면 데이터베이스 접근 횟수를 줄일 수 있다.
* 연관관계를 설정할 때는 엔티티 접근 방식을 필드로 설정해도 프록시를 초기화하지 않는다.

```java
@Entity
@Access(AccessType.PROPERTY)
public Entity() {...}

Entity entity = em.getReference(Entity.class, 1);
entity.getId();
// 엔티티 접근 방식을 프로퍼티로 설정한 경우
// 식별자를 조회할 경우, 프록시는 초기화되지 않는다.

// AccessType.FIELD 일 경우, getId() 가 id 만 조회하는 메소드인지
// 다른 필드까지 활용해서 어떤 일을 하는 메소드인지 알지 못하므로
// 프록시 객체를 초기화 한다.
```

## 프록시 확인

* PersistenceUnitUtil.isLoaded(Object entity) 메소드를 사용하면 프록시 인스턴스의 초기화 여부를 확인할 수 있다.
* 초기화 되었거나 프록시 객체가 아니면 true, 초기화 전인 프록시 객체라면 false 를 리턴한다.
* 프록시 객체의 클래스 명을 출력하면, 원본 클래스의 이름 뒤에 javassist 가 붙어있지만, 프록시를 생성하는 라이브러리에 따라서 달라질 수 있다.

```java
System.out.println(proxyEntity.getClass().getName());
// ....Entity_$$_javassist_0
```
